@model F4ConversationCloud.SuperAdmin.Models.TemplateViewModel
@using BuldanaUrban.Domain.Helpers
@using F4ConversationCloud.Domain.Enum
@using System.ComponentModel.DataAnnotations

@{
    var categoryType = string.Empty;
    categoryType = Model.TemplateCategoryList
            .Where(x => x.Value == Model.TemplateCategory.ToString())
            .Select(x => x.Text)
            .FirstOrDefault();

    var m = Model;
}

<form asp-action="CreateTemplate" method="post" enctype="multipart/form-data" id="mainForm">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <div class="content bg-light">
        <div class="main-content">
            <div class="container-fluid">
                <div class="template-content-wrap">
                    <div class="template-creation-content" id="first-page">
                        <div class="creation-card template-creation">

                            <h3 class="mb-2">Set Up Your Template</h3>
                            <p>Choose the category that best describes your message template. Then select the type of message you want to send.</p>
                            <input asp-for="TemplateCategory" type="hidden" />
                            <input asp-for="ClientInfoId" type="hidden" />
                            <input asp-for="WABAId" type="hidden" />
                            <input asp-for="MetaConfigId" type="hidden" />
                            <ul class="nav nav-tabs conversation-list" id="myTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="marketing-tab" data-bs-toggle="tab" data-bs-target="#marketing" type="button" role="tab" aria-controls="marketing" aria-selected="true">
                                        <span class="marketing-icon tab-icon"></span> Marketing
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="utility-tab" data-bs-toggle="tab" data-bs-target="#utility" type="button" role="tab" aria-controls="utility" aria-selected="false">
                                        <span class="utlity-icon tab-icon"></span> Utility
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="authentication-tab" data-bs-toggle="tab" data-bs-target="#authentication" type="button" role="tab" aria-controls="authentication" aria-selected="false">
                                        <span class="authentication-icon tab-icon"></span> Authentication
                                    </button>
                                </li>
                            </ul>
                            <div class="tab-content pb-0" id="myTabContent">
                                @if (Model.TemplateCategory == (int)TemplateModuleType.Marketing || Model.TemplateCategory == 0)
                                {
                                    <div class="tab-pane fade show active" id="marketing" role="tabpanel" aria-labelledby="marketing">
                                        <partial name="_MarketingTemplateTypeOptions" model="@Model" />
                                    </div>
                                }
                                else if (Model.TemplateCategory == (int)TemplateModuleType.Utility)
                                {
                                    <div class="tab-pane fade show active" id="utility" role="tabpanel" aria-labelledby="Utility">
                                        <partial name="_UtilityTemplateTypeOptions" model="@Model" />
                                    </div>
                                }
                                else if (Model.TemplateCategory == (int)TemplateModuleType.Authentication)
                                {
                                    <div class="tab-pane fade show active" id="authentication" role="tabpanel" aria-labelledby="Authentication">
                                        <partial name="_AuthenticationTemplateTypeOptions" model="@Model" />
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="template-creation-content" id="partialForTemplateForm" style="display:none;">
                        @if (categoryType == TemplateModuleType.Marketing.Get<DisplayAttribute>().Name)
                        {
                            if (Model.TemplateType == (int)MarketingTemplateType.Default)
                            {
                                <partial name="_MarketingDefaultTemplate" model="@Model" />
                            }
                            else if (Model.TemplateType == (int)MarketingTemplateType.Catalogue)
                            {
                                <partial name="_MarketingCatalogueTemplate" model="@Model" />
                            }
                            else if (Model.TemplateType == (int)MarketingTemplateType.CallingPermissionsRequest)
                            {
                                <partial name="_MarketingCallingPermissionsRequestTemplate" model="@Model" />
                            }
                            else if (Model.TemplateType == (int)MarketingTemplateType.Carousel)
                            {
                                <partial name="_MarketingCarouselTemplate" model="@Model" />
                            }
                        }
                        else if (categoryType == TemplateModuleType.Utility.Get<DisplayAttribute>().Name)
                        {
                            if (Model.TemplateType == (int)UtilityTemplateType.Default)
                            {
                                <partial name="_UtilityDefaultTemplate" model="@Model" />
                            }
                            else if (Model.TemplateType == (int)UtilityTemplateType.CallingPermissionsRequest)
                            {
                                <partial name="_UtilityCallingPermissionsRequestTemplate" model="@Model" />
                            }
                            else if (Model.TemplateType == (int)UtilityTemplateType.Carousel)
                            {
                                <partial name="_UtilityCarouselTemplate" model="@Model" />
                            }
                        }
                        else if (categoryType == TemplateModuleType.Authentication.Get<DisplayAttribute>().Name
                        && Model.TemplateType == (int)AuthenticationTemplateType.OneTimePasscode)
                        {
                            <partial name="_AuthenticationOneTimePasscodeTemplate" model="@Model" />
                        }
                    </div>
                    <div class="template-creation-preview">
                        <div class="template-preview-card creation-card">
                            <h4>Template Preview</h4>

                            <div class="template-preview" id="template-preview">
                                <div class="message-chat d-none">
                                    <p>Check out our exclusive festival offers below</p>
                                    <div class="time">11:59</div>
                                </div>
                                <div class="swiper-card">
                                    <div class="template-slide-card">
                                        <span class="default-image image-smaple" id="sample-image" style="display:none;"></span>
                                        <span id="image-preview" style="display:none;"><img src=""></span>
                                        <div class="description">
                                            <h6 class="variables-title" id="header-text-preview" style="display:none;"></h6>
                                            <div id="message-body"></div>
                                            <span class="description-small-text" id="footer-text"></span>
                                        </div>
                                        <div class="time">1:59 PM</div>
                                    </div>
                                    <div id="button-preview">
                                    </div>
                                </div>

                            </div>
                            <div class="mt-3 guidline">
                                <h4 class="mb-1">This template is good for</h4>
                                <p>Welcome messages, promotions, offers, coupons, newsletters, announcements</p>
                            </div>
                            <div class="mt-3 guidline">
                                <h4 class="mb-1">Template areas you can customize</h4>
                                <p>Media, header, body, footer, button</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-strip">
        <div class="bottom-container">
            <button type="button" class="btn secondary-btn" id="discard-btn">Discard</button>
            <button type="button" class="btn secondary-btn" id="previous-btn" style="display:none;">Previous</button>
            <button type="button" class="btn primary-btn" id="next-btn">Next</button>
            <button type="submit" class="btn primary-btn" id="submit-btn" style="display:none;">Submit for review</button>
        </div>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/unobtrusiveHelper.js"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/41.2.0/classic/ckeditor.js"></script>
    <script type="module">
        import 'https://cdn.jsdelivr.net/npm/emoji-picker-element@latest/index.js';
    </script>
    <script>
        $(document).ready(function () {
            $('#TemplateCategory').val(1);

            var storedData = JSON.parse(localStorage.getItem('ClientData'));
            $('#ClientInfoId').val(storedData.ClientInfoId);
            $('#WABAId').val(storedData.WABAId);
            $('#MetaConfigId').val(storedData.MetaConfigId);

            $('.nav-link').on('click', function () {
                var selectedTabId = $(this).attr('id');
                var categoryValue;
                var categoryName = "";

                switch (selectedTabId) {
                    case 'marketing-tab':
                        categoryValue = @((int)TemplateModuleType.Marketing);
                        categoryName = "@(TemplateModuleType.Marketing.Get<DisplayAttribute>().Name)";
                        break;
                    case 'utility-tab':
                        categoryValue = @((int)TemplateModuleType.Utility);
                        categoryName = "@(TemplateModuleType.Utility.Get<DisplayAttribute>().Name)";
                        break;
                    case 'authentication-tab':
                        categoryValue = @((int)TemplateModuleType.Authentication);
                        categoryName = "@(TemplateModuleType.Authentication.Get<DisplayAttribute>().Name)";
                        break;
                }

                $('#TemplateCategory').val(categoryValue);

                $('#myTabContent').show();

                var req = {
                    TemplateCategory: parseInt(categoryValue),
                    TemplateCategoryName: categoryName
                };

                var url = "/TemplateManagement/GetTemplateTypePartialView";

                ajaxHelper.ajaxPost(url, null, req, function (response) {
                    $('#myTabContent').html(response);
                    commonHelper.showHideLoader(false);
                }, null);
            });
        });

        $(document).on('change', 'input[name="TemplateType"]', function () {
            var templateCategory = $('[name="TemplateCategory"]').val();
            var templateType = $('input[name="TemplateType"]:checked').val();

            if ((templateCategory == @((int)TemplateModuleType.Marketing) && templateType == @((int)MarketingTemplateType.Carousel))
            || (templateCategory == @((int)TemplateModuleType.Utility) && templateType == @((int)UtilityTemplateType.Carousel))){
                $('#carousel-template-preview').show();
                $('#template-preview').hide();
            }
            else{
                $('#carousel-template-preview').hide();
                $('#template-preview').show();
            }
        });

        $(document).on('click', '#marketing-tab, #utility-tab, #authentication-tab', function () {
            var category = $(this).text().trim();

            $('#carousel-template-preview').hide();
            $('#template-preview').show();
        });

        $(document).on('click', '#next-btn', function () {
            commonHelper.showHideLoader(true);
            var templateCategoryText = $('input[name="TemplateCategory"]:checked').next('label').text().trim();
            var templateCategory = $('[name="TemplateCategory"]').val();
            var templateTypeText = $('input[name="TemplateType"]:checked').next('label').text().trim();
            var templateType = $('input[name="TemplateType"]:checked').val();

            $('#partialForTemplateForm').show();
            var req = {
                TemplateCategory: parseInt(templateCategory),
                TemplateCategoryName: templateCategoryText,
                TemplateType: parseInt(templateType),
                TemplateTypeName: templateTypeText
            };

            var url = "/TemplateManagement/GetTemplateFormPartialView";

            ajaxHelper.ajaxPost(url, null, req, function (response) {
                $('#partialForTemplateForm').html(response);
                $('#first-page').hide();
                $('#next-btn').hide();
                $('#discard-btn').hide();
                $('#submit-btn').show();
                $('#previous-btn').show();
                $('#title').text('untitled');
                $('#language-title').text('English');

                var $form = $("#mainForm");
                $form.removeData("validator").removeData("unobtrusiveValidation");
                $.validator.unobtrusive.parse($form);
                $('[name="MediaType"]').trigger('change');

                var variableCounter = 1;
                var selectedVariableType = null;

                ClassicEditor
                    .create(document.querySelector('#MessageBody'), {
                        toolbar: [
                            'bold', 'italic', 'underline', 'strikethrough',
                            'numberedList', 'bulletedList',
                            'link'
                        ],
                        initialData: 'Hello'
                    })
                    .then(editor => {
                        editorInstance = editor;
                        var firstcontent = editor.getData();
                        $('#message-body').html(firstcontent);
                        var previousVariables = [];
                        var bodyValuesCache = {};

                        // Live validation on content change
                        editor.model.document.on('change:data', () => {
                            try{
                                var content = editor.getData();
                                $('#message-body').html(content);
                                $("#submit-btn").prop("disabled", content === '');
                                validateWhatsAppVariables(content);
                                validateSubmitButton(editor);

                                var variables = extractUniqueVariables(content);

                                var variablesChanged =
                                variables.length !== previousVariables.length ||
                                variables.some((v, i) => v !== previousVariables[i]);

                                if (!variablesChanged) return;

                                // Cache current values
                                bodyValuesCache = {};
                                document.querySelectorAll('#variable-card-body .body-var-row').forEach(row => {
                                    var number = row.getAttribute('data-number');
                                    var input = row.querySelector('input[name^="bodyVariables"][name$=".BodyVariableName"]');
                                    if (input) {
                                        bodyValuesCache[number] = input.value;
                                    }
                                });

                                previousVariables = [...variables];

                                $.ajax({
                                    url: '/TemplateManagement/RenderBodyVariablesPartial',
                                    type: 'POST',
                                    contentType: 'application/json',
                                    data: JSON.stringify(variables),
                                    success: function (html) {
                                        $('#variable-card').show();
                                        $('#variable-card-body').html(html).show();

                                        document.querySelectorAll('#variable-card-body .body-var-row').forEach(row => {
                                            var number = row.getAttribute('data-number');
                                            var input = row.querySelector('input[name^="bodyVariables"][name$=".BodyVariableName"]');
                                            if (input && bodyValuesCache[number]) {
                                                input.value = bodyValuesCache[number];
                                            }
                                        });

                                        bindBodyVariableInputListener(editor);
                                        validateSubmitButton(editor);
                                    },
                                    error: function () {
                                        commonHelper.showError("Failed to load variable partials.");
                                    }
                                });
                            }
                            catch(err){
                                console.log(err)
                            }
                        });

                        // Emoji picker
                        var picker = document.getElementById('picker');
                        picker.addEventListener('emoji-click', event => {
                            editor.model.change(writer => {
                                var insertPosition = editor.model.document.selection.getFirstPosition();
                                writer.insertText(event.detail.unicode, insertPosition);
                            });
                        });

                        // Variable insertion
                        $(document).on("click", "#add-body-variable", function () {
                            selectedVariableType = $('input[name="VariableType"]:checked').val();

                            if (!selectedVariableType) {
                               commonHelper.showError("Please select type of variable.");
                               return;
                            }

                            // Use current editor content to determine the next available number
                            var currentContent = editor.getData();
                            var nextNumber = getNextAvailableVariableNumberFromContent(currentContent);

                            var variableText = ` {{${nextNumber}}}`;
                            editor.model.change(writer => {
                                var insertPosition = editor.model.document.selection.getFirstPosition();
                                writer.insertText(variableText, insertPosition);
                            });

                            // Trigger validation after insertion
                            var updatedContent = editor.getData();
                            validateWhatsAppVariables(updatedContent);
                        });

                        function getNextAvailableVariableNumberFromContent(content) {
                            var regex = /{{\d+}}/g;
                            var matches = [...content.matchAll(regex)];
                            var usedNumbers = matches.map(m => parseInt(m[0].replace(/[{}]/g, ''), 10));

                            if (usedNumbers.length === 0) return 1;

                            // Find the smallest missing positive integer starting at 1
                            var set = new Set(usedNumbers);
                            var i = 1;
                            while (set.has(i)) i++;
                            return i;
                        }
                    })
                    .catch(error => {
                        alert();
                        console.error(error);
                    });

                    function extractUniqueVariables(content) {
                        var regex = /\{\{(\d+)\}\}/g;
                        var found = new Set();
                        var match;
                        while ((match = regex.exec(content)) !== null) {
                            found.add(match[1]); // only the number part
                        }
                        return Array.from(found).sort((a, b) => a - b); // sorted for consistency
                    }

                    // Bind live validation on typing inside the body variable inputs
                    function bindBodyVariableInputListener(editor) {
                        $('#variable-card-body').off('input.body-var') // avoid duplicate binding
                           .on('input.body-var', 'input[name$=".BodyVariableName"]', function () {
                           validateSubmitButton(editor);
                        });
                    }

                    document.addEventListener('click', function (event) {
                        var emojiBtn = document.getElementById('emoji-btn');
                        var emojiCard = document.getElementById('emoji-card');

                        if (emojiBtn.contains(event.target)) {
                            // Toggle emoji picker
                            emojiCard.style.display = emojiCard.style.display === 'none' ? 'block' : 'none';
                        } else if (!emojiCard.contains(event.target)) {
                            // Clicked outside emoji picker
                            emojiCard.style.display = 'none';
                        }
                    });

                // Variable type selection
                document.querySelectorAll('input[name="VariableType"]').forEach(radio => {
                    radio.addEventListener('change', function () {
                        selectedVariableType = this.value;
                    });
                });

                // WhatsApp variable validation logic
                function validateWhatsAppVariables(content) {
                    var regex = /{{\d+}}/g;
                    var matches = [...content.matchAll(regex)];

                    var numbers = matches.map(m => parseInt(m[0].replace(/[{}]/g, '')));
                    var uniqueNumbers = [...new Set(numbers)];

                    var errorMessage = "";

                    // Rule 1: No duplicates
                    if (numbers.length !== uniqueNumbers.length) {
                        errorMessage += "Duplicate variables found. "
                    }

                    // Rule 2: Sequential starting from 1
                    uniqueNumbers.sort((a, b) => a - b);
                    for (var i = 0; i < uniqueNumbers.length; i++) {
                        if (uniqueNumbers[i] !== i + 1) {
                            errorMessage += "Variables must be sequential starting from {{1}}. "
                        }
                    }

                    // Rule 3: Each variable must be surrounded by at least 3 normal words
                    var hasSurroundingWordError = false;

                    for (var match of matches) {
                        var index = match.index;
                        const varLen = match[0].length;

                        var before = content.substring(0, index);
                        var after = content.substring(index + varLen);

                        var beforeCount = countWordsExcludingVariables(before);
                        var afterCount = countWordsExcludingVariables(after);

                        if (!(beforeCount >= 2 && afterCount >= 2)) {
                            hasSurroundingWordError = true;
                            break;
                        }
                    }

                    if (hasSurroundingWordError) {
                        errorMessage += "Each variable must be surrounded by at least 4 words combined before and after.";
                    }

                    var errorSpan = document.getElementById("messageBodyError");

                    if (errorMessage != '') {
                        errorSpan.innerText = errorMessage.trim();
                        errorSpan.style.display = "block";
                        //$("#submit-btn").prop("disabled", true);
                    } else {
                        errorSpan.innerText = "";
                        errorSpan.style.display = "none";
                        //$("#submit-btn").prop("disabled", false);
                    }
                    return errorMessage;
                }

                function countWordsExcludingVariables(text) {
                    if (!text) return 0;

                    // 1) Normalize HTML entities that behave like spaces
                    var clean = text.replace(/&nbsp;/gi, ' ').replace(/\u00A0/g, ' '); // non-breaking space

                    // 2) Remove HTML tags (CKEditor outputs real <tags>, not &lt; &gt;)
                    clean = clean.replace(/<[^>]*>/g, ' ');

                    // 3) Remove all variables like {{1}}, {{22}}, ...
                    clean = clean.replace(/{{\d+}}/g, ' ');

                    // 4) Normalize whitespace
                    clean = clean.replace(/\s+/g, ' ').trim();

                    // 5) Count word tokens (Unicode letters/digits/underscore)
                    // If your environment doesn't support \p{L} and \p{N}, fall back to /[A-Za-z0-9_]+/g
                    var wordMatches = clean.match(/\b[\p{L}\p{N}_]+\b/gu) || [];
                    return wordMatches.length;
                }

                document.getElementById('UploadedFile').addEventListener('change', function (event) {
                    var file = event.target.files[0];
                    var fileNameSpan = document.getElementById('file-name');
                    var imageTag = document.querySelector('.image img');
                    var cardPreviewImg = document.querySelector('#image-preview img');
                    var imagePreviewSpan = document.getElementById('image-preview');

                    if (file && file.type.startsWith('image/')) {
                        var reader = new FileReader();

                        reader.onload = function (e) {
                            var img = new Image();
                            img.onload = function () {
                                // if (img.width === 192 && img.height === 192) {
                                    // Valid size — show previews
                                    if (window.$) {
                                        $('.image-upload').show();
                                    } else {
                                        document.querySelector('.image-upload').style.display = 'block';
                                    }

                                    if (imageTag) imageTag.src = e.target.result;
                                    if (cardPreviewImg) cardPreviewImg.src = e.target.result;
                                    if (fileNameSpan) fileNameSpan.textContent = file.name;
                                    if (imagePreviewSpan) imagePreviewSpan.style.display = 'block';
                                    $('#submit-btn').prop('disabled', false);
                                    $('#sample-image').hide();
                                // } else {
                                //     commonHelper.showError("Please upload an image of exactly 192×192 pixels.");
                                //     resetPreview();
                                // }
                            };
                            img.src = e.target.result;
                        };

                        reader.readAsDataURL(file);
                    } else {
                        resetPreview();
                    }

                    function resetPreview() {
                        $('#submit-btn').prop('disabled', true);
                        if (fileNameSpan) fileNameSpan.textContent = '';
                        if (imageTag) imageTag.src = '';
                        if (cardPreviewImg) cardPreviewImg.src = '';
                        if (imagePreviewSpan) imagePreviewSpan.style.display = 'none';
                        if (window.$) {
                            $('.image-upload').hide();
                        } else {
                            document.querySelector('.image-upload').style.display = 'none';
                        }
                        document.getElementById('UploadedFile').value = '';
                    }
                });

                document.getElementById('remove-file').addEventListener('click', function () {
                    $('#sample-image').show();
                    deleteImage(true);
                });

                commonHelper.showHideLoader(false);
            }, null);
        });

        $(document).on('click', '#previous-btn', function () {
            commonHelper.showHideLoader(true);
            $('#partialForTemplateForm').hide();
            $('#first-page').show();
            $('#next-btn').show();
            $('#discard-btn').show();
            $('#submit-btn').hide();
            $('#previous-btn').hide();
            commonHelper.showHideLoader(false);
        });

        $(document).on('input', '[name="TemplateName"]', function () {
            var nameVal = $(this).val().trim();

            if (nameVal == ''){
                $('#title').text('untitled');
            }
            else{
                $('#title').text(nameVal);
            }
        });

        $(document).on('change', '[name="Language"]', function () {
            var languageVal = $('[name="Language"] option:selected').text();

            if (languageVal == ''){
                $('#language-title').text('');
            }
            else{
                $('#language-title').text(languageVal);
            }
        });

        $(document).on('change', '[name="MediaType"]', function () {
            var selectedValue = $('input[name="MediaType"]:checked').val();
            var selectedText = $('input[name="MediaType"]:checked').next('label').text().trim();
            var $fileInput = $('#UploadedFile');
            var $attachment = $('#attachment');
            var $existingFileLink = $('#existingFileLink');
            var $fileValidationMessage = $('[data-valmsg-for="File"]');
            $fileInput.val('');
            $existingFileLink.html('');
            $fileInput.removeAttr('accept');
            var hasValidationError = $fileValidationMessage.text().trim().length > 0;
            if (selectedText == 'Image'){
                $('#sample-image').show();
            }
            else{
                $('#sample-image').hide();
            }
            var isSubmitEnabled = (selectedValue > 0 && $fileInput.val() == '');
            deleteImage(isSubmitEnabled);

            if (selectedValue > 0 && selectedText != 'Location') {
                $attachment.show();

                switch (selectedText) {
                    case 'Image':
                        $fileInput.attr('accept', '.jpg,.jpeg,.png');
                        break;
                    case 'Video':
                        $fileInput.attr('accept', '.mp4,.avi,.mov,.wmv');
                        break;
                    case 'Document':
                        $fileInput.attr('accept', '.pdf,.doc,.docx,.xls,.xlsx');
                        break;
                }
            }else if (!hasValidationError) {
                $attachment.hide();
            }

            if (selectedValue > 0){
                $('#Header').val('');
                $('#HeaderVariableValue').val('');
                $('#variable-card-header').hide();
                $("#header-add-btn").attr("disabled", true);
                $('#Header').attr('disabled', true);
                $('#header-text-preview').text('');
            }
            else{
                $("#header-add-btn").removeAttr("disabled");
                $('#Header').removeAttr('disabled');
            }
        });

        $(document).on('click', '#header-add-btn', function (e) {
            e.preventDefault();

            var headerInput = document.querySelector("input[name='Header']");
            var variableTypeSelect = $('input[name="VariableType"]:checked').next('label').text().trim();
            var variableToInsert = "";

            if (variableTypeSelect == null || variableTypeSelect == ''){
                commonHelper.showError("Please select type of variable.");
                return;
            } else if (variableTypeSelect === "Number") {
                variableToInsert = "{{1}}";
            } else if (variableTypeSelect === "Name") {
                variableToInsert = "{{variable_name}}";
            }
            $('#variable-card').show();
            $('#variable-card-header').show();
            $('[name="HeaderVariableName"]').val("{{1}}");
            $('#header-text-preview').show();
            $('#header-text-preview').text("{{1}}");
            $("#submit-btn").prop("disabled", true);

            // Check if variable already exists
            if (!headerInput.value.includes("{{")) {
                headerInput.value += variableToInsert;
                $('#header-add-btn').attr('disabled', true);
            } else {
                commonHelper.showError("Only one variable is supported in the header.");
            }
        });

        function validateSubmitButton(editor) {
            var content = editor.getData().trim();
            var contentEmpty = content === '';

            var messageBodyErrorVisible = $('#messageBodyError').css('display') == 'block';
            var bodyInputs = document.querySelectorAll(
                '#variable-card-body input[name^="bodyVariables"][name$=".BodyVariableName"]'
            );
            var anyBodyEmpty = Array.from(bodyInputs).some(inp => !inp.value.trim());

            // Header variable logic
            var headerText = $('[name="Header"]').val()?.trim() || '';
            var headerHasVariable = headerText.includes('{{1}}');
            var headerVariableName = $('[name="HeaderVariableName"]').val()?.trim() || '';
            var headerVariableValue = $('[name="HeaderVariableValue"]').val()?.trim() || '';
            var headerInvalid = headerHasVariable && (headerVariableName === '' || headerVariableValue === '');
            var buttonsInvalid = hasButtonValidationErrors();
            // var con = {
            //     contentEmpty: contentEmpty,
            //     messageBodyErrorVisible: messageBodyErrorVisible,
            //     anyBodyEmpty: anyBodyEmpty,
            //     headerInvalid: headerInvalid,
            //     buttonsInvalid: buttonsInvalid
            // }
            // console.log(con);
            // Final check
            var shouldDisable = contentEmpty || messageBodyErrorVisible || anyBodyEmpty || headerInvalid || buttonsInvalid;
            $('#submit-btn').prop('disabled', shouldDisable);
        }

        function hasButtonValidationErrors() {
            // 1) If any button input has the 'is-invalid' class
            var anyInvalidClass = $('#quick-reply-list input[name^="buttons"][name$=".ButtonText"]').is('.is-invalid');

            // 2) Or any validation span for buttons has non-empty text
            var anySpanError = false;
            $('#quick-reply-list span.button-text-validation[data-valmsg-for]').each(function () {
                var msg = $(this).text().trim();
                if (msg.length) {
                    // Optionally, limit to just buttons fields:
                    var forName = $(this).attr('data-valmsg-for') || '';
                    if (/^buttons\[\d+\]\.ButtonText$/.test(forName) && msg.length) {
                        anySpanError = true;
                        return false; // break .each
                    }
                }
            });

            return anyInvalidClass || anySpanError;
        }

        $(document).on('input', '[name="Header"]', function () {
            var headerVal = $(this).val().trim();

            $('#header-add-btn').attr('disabled', headerVal !== '' && headerVal.includes("{{1}}"));

            var isValid = $(this).valid();

            if (isValid && headerVal != '') {
                if (headerVal.includes("{{1}}")){
                    $('#variable-card').show();
                    $('#variable-card-header').show();
                    $('[name="HeaderVariableName"]').val("{{1}}");
                }
                $('#header-text-preview').show();
                $('#header-text-preview').text(headerVal);
                $("#submit-btn").prop("disabled", true);
            }
            else {
                $('#variable-card').hide();
                $('#variable-card-header').hide();
                $('[name="HeaderVariableName"]').val('');
                $('#header-text-preview').hide();
                $("#submit-btn").prop("disabled", false);
            }

            validateSubmitButton(editorInstance);
        });

        $(document).on('input', '[name="HeaderVariableValue"]', function () {
            validateSubmitButton(editorInstance);
            // var headerVariableVal = $(this).val().trim();
            // if (headerVariableVal != null && headerVariableVal != ''){
            //     $("#submit-btn").prop("disabled", false);
            // }
            // else{
            //     $("#submit-btn").prop("disabled", true);
            // }
        });

        $(document).on('change', '[name="VariableType"]', function () {
            $('#header-add-btn').attr('disabled', false);
            var newMessage = "";
            var variableTypeSelect = $('input[name="VariableType"]:checked').next('label').text().trim();

            if (variableTypeSelect === "Number") {
                newMessage = "Variable parameters must be whole numbers with two sets of curly brackets (e.g., {{1}}).";
            } else if (variableTypeSelect === "Name") {
                newMessage = "Variable parameters must be lowercase characters, underscores and numbers with two sets of curly brackets (e.g., {{customer_name}}, {{order_id}}).";
            }

            var $headerInput = $('[name="Header"]');

            // Update the data attribute (optional, for consistency)
            $headerInput.attr('data-val-headervariableformat', newMessage);

            // Update the validator's internal message directly
            var validator = $headerInput.closest("form").validate();
            validator.settings.messages.Header = validator.settings.messages.Header || {};
            validator.settings.messages.Header.headervariableformat = newMessage;

            $('#Header').valid();
        });

        $(document).on('input', '[name="Footer"]', function () {
            var footerVal = $(this).val().trim();

            $('#footer-text').text(footerVal);
        });

        $(document).on('submit', 'form', function (e) {
            if (this.checkValidity()) {
                commonHelper.showHideLoader(true);
            } else {
                commonHelper.showHideLoader(false);
            }
        });

        $(document).on('click', '#discard-btn', function (e) {
            commonHelper.showHideLoader(true);
            var storedData = JSON.parse(localStorage.getItem('ClientData'));
            location.href = '@Url.Action("ClientDetails", "ClientManagement")' + "/" + encodeURIComponent(storedData.MetaConfigId);
        });

        function deleteImage(isSubmitEnabled) {
            if (isSubmitEnabled){
                $('#submit-btn').prop('disabled', true);
            }
            else{
                $('#submit-btn').prop('disabled', false);
            }
            var imageTag = document.querySelector('.image img');
            var cardPreviewImg = document.querySelector('#image-preview img');
            var imagePreviewSpan = document.getElementById('image-preview');
            var fileNameSpan = document.getElementById('file-name');
            var fileInput = document.getElementById('UploadedFile');

            if (fileNameSpan) fileNameSpan.textContent = '';
            if (fileInput) fileInput.value = '';
            if (imageTag) imageTag.src = '';
            if (cardPreviewImg) cardPreviewImg.src = '';
            if (imagePreviewSpan) imagePreviewSpan.style.display = 'none';

            if (window.$) {
                $('.image-upload').hide();
            } else {
                document.querySelector('.image-upload').style.display = 'none';
            }
        }

        (function ($) {
            var MAX_CUSTOM_BUTTONS = 10;

            function getNextIndex() {
                var max = -1;
                $('#quick-reply-list .button-row').each(function () {
                    var idx = parseInt($(this).attr('data-index'), 10);
                    if (!isNaN(idx) && idx > max) max = idx;
                });
                return max + 1;
            }

            function getCustomCount() {
                return $('#quick-reply-list .button-row').length;
            }

            function ensureSectionVisibility() {
                $('#quick-reply-section').toggle($('#quick-reply-list .button-row').length > 0);

                var isMax = getCustomCount() >= MAX_CUSTOM_BUTTONS;
                $('#buttonDrpDwnBtn').prop('disabled', isMax);
                $('.add-btn-template').toggleClass('disabled', isMax);
            }

            // Dropdown click -> add row
            $(document).on('click', '#template-btn a.dropdown-item', function (e) {
                e.preventDefault();
                var link = this;
                var value = link.dataset.value;
                var text  = link.dataset.text;

                var current = getCustomCount();
                if (current >= MAX_CUSTOM_BUTTONS) {
                    commonHelper.showError('You can add a maximum of ' + MAX_CUSTOM_BUTTONS + ' buttons.');
                    return;
                }

                var index = getNextIndex();
                var currentCount = getCustomCount();
                $.ajax({
                    type: 'POST',
                    url: '/TemplateManagement/GetButtonPartialView',
                    data: { value: value, text: text, index: index, currentCount: currentCount },
                    success: function (html) {
                        var $html = $(html);
                        if (!$html.attr('data-category')) {
                            $html.attr('data-category', 'Custom');
                        }
                        $('#quick-reply-list').append($html);
                        var previewHtml = '<div class="buy-link" data-index="' + index + '" id="preview-' + index + '">' +
                         '<a href="#"><i class="backward"></i> Quick Reply</a>' +
                            '</div>';
                        $('#button-preview').append(previewHtml);
                        ensureSectionVisibility();
                    },
                    error: function (xhr) {

                    }
                });
            });

            // Delete a row
            $(document).on('click', '#quick-reply-list .button-row .delete', function (e) {
                e.preventDefault();
                var $row = $(this).closest('.button-row');
                var idx = $row.data('index');
                $row.remove();
                $('#button-preview .buy-link[data-index="' + idx + '"]').remove();
                ensureSectionVisibility();
                validateDuplicateButtonTexts();
            });

            $(document).on('input', '#quick-reply-list input[name^="buttons"][name$=".ButtonText"]', function () {
                var $input = $(this);
                validateDuplicateButtonTexts();
                // Extract index from name: buttons[0].ButtonText -> 0
                var name = $input.attr('name'); // e.g., "buttons[0].ButtonText"
                var match = name.match(/^buttons\[(\d+)\]\.ButtonText$/);
                if (!match) return;

                var idx = match[1];
                var text = $input.val().trim();

                // Find the matching preview: prefer data-index, fallback to id
                var $preview = $('#button-preview .buy-link[data-index="' + idx + '"]');
                var $previewFallback = $('#preview-' + idx);

                // Choose whichever exists
                var $target = $preview.length ? $preview : $previewFallback;

                if ($target.length) {
                    // Update only the text inside the <a>, keep the icon intact
                    var $anchor = $target.find('a');

                    // If you want a placeholder when empty:
                    var displayText = text.length ? text : 'Quick Reply';

                    // Replace the text node after the icon
                    // Safer approach: rebuild anchor contents
                    $anchor.html('<i class="backward"></i> ' + displayText);
                }
            });

            // On page load (edit mode), show/hide based on existing rows
            $(function () {
                ensureSectionVisibility();
            });

            function validateDuplicateButtonTexts() {
                var FIXED_MSG = "You can't enter same text for multiple buttons.";

                // Collect all ButtonText inputs
                var $inputs = $('#quick-reply-list input[name^="buttons"][name$=".ButtonText"]');

                // Group by normalized text (trim + lower)
                var groups = new Map(); // key -> [{ $input, name }]
                $inputs.each(function () {
                    var $input = $(this);
                    var name = $input.attr('name'); // e.g., buttons[3].ButtonText
                    var match = name && name.match(/^buttons\[(\d+)\]\.ButtonText$/);
                    if (!match) return;

                    var raw = ($input.val() || '').trim();
                    if (!raw) return; // ignore empty while typing

                    var key = raw.toLowerCase();
                    if (!groups.has(key)) groups.set(key, []);
                    groups.get(key).push({ $input: $input, name: name });
                });

                // Determine duplicates: mark all but the first in each group
                var duplicateNodes = new Set();
                groups.forEach(function (entries) {
                    if (entries.length > 1) {
                        entries.slice(1).forEach(function (e) {
                            duplicateNodes.add(e.$input.get(0));
                        });
                    }
                });

                // Apply/clear UI state and messages
                $inputs.each(function () {
                    var $input = $(this);
                    var name = $input.attr('name') || '';
                    var isDup = duplicateNodes.has(this);

                    // Toggle Bootstrap invalid class
                    $input.toggleClass('is-invalid', isDup);

                    // Find the corresponding asp-validation-for span
                    var selector = 'span.button-text-validation[data-valmsg-for="' + name.replace(/\./g, '\\.') + '"]';
                    var $span = $(selector);

                    if (isDup) {
                        // Set the fixed duplicate message
                        $span.text(FIXED_MSG);
                    } else {
                        // Clear only if our fixed message is currently shown
                        var current = ($span.text() || '').trim();
                        if (current === FIXED_MSG) {
                            $span.text('');
                        }
                    }
                });

                // Re-evaluate submit button availability
                if (typeof validateSubmitButton === 'function') {
                    try { validateSubmitButton(editorInstance); } catch (_) {}
                }

                // Return true if there are no duplicates
                return duplicateNodes.size === 0;
            }

            $(document).on('ajaxComplete', function (event, xhr, settings) {
                if (settings && settings.url && settings.url.indexOf('/TemplateManagement/GetButtonPartialView') === 0) {
                    // Allow DOM to update then validate
                    setTimeout(validateDuplicateButtonTexts, 0);
                }
            });

            document.addEventListener('change', function (e) {
                var target = e.target;
                if (target.matches('.button-row select[asp-for], .button-row select.form-select')) {
                    var row = target.closest('.button-row');
                    var index = row?.dataset.index;
                    var selectedValue = target.value;
                    var btnText = '';
                    if (selectedValue == @((int)CustomButtonType.Custom)){
                        btnText = 'Quick Reply';
                        $('[name="buttons[' + index + '].ButtonText"]').val(btnText);
                    }
                    else{
                        btnText = 'Preconfigured Response';
                        $('[name="buttons[' + index + '].ButtonText"]').val(btnText);
                    }

                    var newHtml = '<div class="buy-link" data-index="' + index + '" id="preview-' + index + '">' +
                         '<a href="#"><i class="backward"></i>' + btnText + '</a>' +
                            '</div>';

                    $('#preview-' + index).replaceWith(newHtml);

                    validateDuplicateButtonTexts();
                }
            });

        })(jQuery);
    </script>
}