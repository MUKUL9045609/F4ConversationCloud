@using F4ConversationCloud.Application.Common.Models.SuperAdmin
@model F4ConversationCloud.SuperAdmin.Models.UsageViewModel
@{
    ViewData["Title"] = "Usages";
}
<div class="content">
    <div class="container-fluid">

        <div class="card padding">
            <div class="header-content">
                <h3 class="sub-heading">Usages</h3>
                <div class="d-flex form-wrapper align-items-end gap-2">
                    <div>

                        <div id="reportrange" class="reportrange form-control date-form-control">
                            <i class="dateIcon"></i>&nbsp;
                            <span></span>
                        </div>
                        <input asp-for="StartDate" type="hidden" id="fromDate" class="form-control" />
                        <input asp-for="EndDate" type="hidden" class="form-control" id="toDate" />
                       
                    </div>
                    <div class="d-flex gap-2">
                        @* <button class="btn primary-btn" id="filterbtn" disabled>Filter</button> *@
                        
                        <button class="btn secondary-btn" onclick="clearQueryParams()"><i class="reset"></i></button>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table id="example" class="table user-table billing-table form-wrapper">
                    <thead>
                        <tr>
                            <th>Sr. <br>No</th>

                            <th>
                                @Html.DisplayNameFor(model => model.Columns.OrganizationName)
                                <div class="input-group">
                                    <input asp-for="OrganizationsNameFilter" type="text" class="form-control srcIcon" placeholder="Search">
                                    <span class="searchIcon" onclick="loadData()"></span>
                                </div>
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Columns.WabaPhoneNumber)
                                <div class="input-group">
                                    <input asp-for="WabaPhoneNumberFilter" type="text" class="form-control srcIcon" placeholder="Search">
                                    <span class="searchIcon" onclick="loadData()"></span>
                                </div>
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Columns.WhatsAppDisplayName)
                                <div class="input-group">
                                    <input asp-for="WhatsAppDisplayNameFilter" type="text" class="form-control srcIcon" placeholder="Search">
                                    <span class="searchIcon" onclick="loadData()"></span>
                                </div>
                            </th>

                            <th> Conversation Type</th>
                            <!-- <th>Duration</th> -->
                            <th>Message</th>
                            <th>Total Amount</th>
                            <th>Actions</th>
                        </tr>

                    </thead>
                    <tbody>
                        @if (!Model.data.Any())
                        {
                            <tr>
                                <td colspan="8" class="text-center">No Records Found</td>
                            </tr>
                        }
                        else
                        {
                            var anyRowDisplayed = false;

                            foreach (var item in Model.data)
                            {
                                var phoneNumbers = (item.WabaPhoneNumber ?? "").Split(',', StringSplitOptions.RemoveEmptyEntries);
                                var displayNames = (item.WhatsAppDisplayName ?? "").Split(',', StringSplitOptions.RemoveEmptyEntries);

                                for (int p = 0; p < phoneNumbers.Length; p++)
                                {
                                    int maxRows = 3;

                                    for (int i = 0; i < maxRows; i++)
                                    {
                                        TemplateMessageInsightsListViewItem insight = null;
                                        string conversationType = "";

                                        switch (i)
                                        {
                                            case 0:
                                                insight = item.TemplateInsightsList?.FirstOrDefault(x => x.ConversationType == "Marketing");
                                                conversationType = "Marketing";
                                                break;
                                            case 1:
                                                insight = item.TemplateInsightsList?.FirstOrDefault(x => x.ConversationType == "Utility");
                                                conversationType = "Utility";
                                                break;
                                            case 2:
                                                insight = item.TemplateInsightsList?.FirstOrDefault(x => x.ConversationType == "Authentication");
                                                conversationType = "Authentication";
                                                break;
                                        }

                                        bool skipRow = (Model.StartDate.HasValue || Model.EndDate.HasValue)
                                        && (insight == null || insight.TotalMessageSentCount == 0);
                                        if (skipRow)
                                            continue;

                                        anyRowDisplayed = true;

                                        <tr>
                                            @if (p == 0 && i == 0)
                                            {
                                                <td rowspan="@(phoneNumbers.Length * 3)" class="text-center">@item.SrNo</td>
                                                <td rowspan="@(phoneNumbers.Length * 3)">
                                                    <a method="get" asp-controller="ClientRegistration" asp-action="RegisteredBusinessDetails" asp-route-id="@item.ClientInfoId" class="mb-1 d-block" id="name-link">
                                                        @Html.DisplayFor(modelItem => item.OrganizationsName)
                                                    </a>
                                                    <span class="business-category">
                                                        <span class="fw-medium">Client Id: </span>@item.ClientId
                                                    </span>
                                                </td>
                                            }

                                            @if (i == 0)
                                            {
                                                <td rowspan="3">
                                                    <a method="get" asp-controller="ClientRegistration" asp-action="RegisteredBusinessDetails" asp-route-id="@item.ClientInfoId" class="mb-1 d-block" id="name-link">@phoneNumbers[p]</a>
                                                </td>
                                                <td rowspan="3">
                                                    @displayNames.ElementAtOrDefault(p)
                                                </td>
                                            }

                                            <td>@conversationType</td>
                                            <td>@(insight?.TotalMessageSentCount ?? 0)</td>
                                            <td>₹@(insight?.TotalAmount ?? 0)</td>

                                            @if (p == 0 && i == 0)
                                            {
                                                <td rowspan="@(phoneNumbers.Length * 3)">
                                                    <div class="action justify-content-center">
                                                        <a href="#" class="download" download=""></a>
                                                    </div>
                                                </td>
                                            }
                                        </tr>
                                    }
                                }
                            }

                            if (!anyRowDisplayed)
                            {
                                <tr>
                                    <td colspan="8" class="text-center">No Records Found</td>
                                </tr>
                            }
                        }
                    </tbody>

                </table>
            </div>
            <partial name="_Pagination" model="new PaginationViewModel { PageNumber = Model.PageNumber, PageSize = Model.PageSize, TotalCount = Model.TotalCount }" />
        </div>

    </div>
</div>
@section Scripts{

    <script>
          function clearQueryParams() {

              document.getElementById('fromDate').value = '';
              document.getElementById('toDate').value = '';
                $("[name=OrganizationsNameFilter]").val('');
                $("[name=WabaPhoneNumberFilter]").val('');
                $("[name=WhatsAppDisplayNameFilter]").val('');
              //$("#servicetype").val(0);

              let url = window.location.origin + window.location.pathname;
              window.location.href = url;
          }
      function loadData() {
            let organizationsNameFilter = $("[name=OrganizationsNameFilter]").val();
            let wabaPhoneNumberFilter = $("[name=WabaPhoneNumberFilter]").val();
            let whatsAppDisplayNameFilter = $("[name=WhatsAppDisplayNameFilter]").val();
            let StartDate = $("#fromDate").val();
            let EndDate = $("#toDate").val();
            let pageNumber = 1;
                    location.href = '@Url.Action("List", "Usages")' +
                    '?WhatsAppDisplayNameFilter=' + whatsAppDisplayNameFilter +
                    '&WabaPhoneNumberFilter=' + encodeURIComponent(wabaPhoneNumberFilter) +
                    '&organizationsNameFilter=' + encodeURIComponent(organizationsNameFilter) +
                    '&StartDate=' + encodeURIComponent(StartDate) +
                    '&EndDate=' + encodeURIComponent(EndDate) +
                    '&PageNumber=' + pageNumber;
        }
        $(".page-link").click(function () {
        var pageNumber = $(this).data("page-number");
            if (pageNumber !== undefined && pageNumber !== null) {
                    let organizationsNameFilter = $("[name=OrganizationsNameFilter]").val();
                    let wabaPhoneNumberFilter = $("[name=WabaPhoneNumberFilter]").val();
                    let whatsAppDisplayNameFilter = $("[name=WhatsAppDisplayNameFilter]").val();
                    let StartDate = $("#fromDate").val();
                    let EndDate = $("#toDate").val();
                      location.href = '@Url.Action("List", "Usages")' +
                        '?WhatsAppDisplayNameFilter=' + whatsAppDisplayNameFilter +
                        '&WabaPhoneNumberFilter=' + encodeURIComponent(wabaPhoneNumberFilter) +
                        '&organizationsNameFilter=' + encodeURIComponent(organizationsNameFilter) +
                        '&StartDate=' + encodeURIComponent(StartDate) +
                        '&EndDate=' + encodeURIComponent(EndDate) +
                        '&PageNumber=' + pageNumber;
            }
        });


        $(".srcIcon").on("keypress", function (e) {
            if (e.which == 13) {
                loadData();
            }
        });



        $(document).ready(function () {
                function cb(start, end) {
                    if (start && end) {
                        $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                        var startDate = start.format('YYYY-MM-DD');
                        var endDate = end.format('YYYY-MM-DD');
                        $("[name=StartDate]").val(startDate);
                        $("[name=EndDate]").val(endDate);
                        $('#startDateInput').val(startDate);
                        $('#endDateInput').val(endDate);
                    } else {
                        $('#reportrange span').html('Select Date Range');
                        $("[name=StartDate]").val('');
                        $("[name=EndDate]").val('');
                        $('#startDateInput').val('');
                        $('#endDateInput').val('');
                    }
                }
                 var modelData = {
                    StartDate: "@(Model.StartDate?.ToString("yyyy-MM-dd HH:mm:ss") ?? "")",
                    EndDate: "@(Model.EndDate?.ToString("yyyy-MM-dd HH:mm:ss") ?? "")"
                };
                        var start = modelData.StartDate ? moment(modelData.StartDate, 'YYYY-MM-DD ') : null;
                        var end = modelData.EndDate ? moment(modelData.EndDate, 'YYYY-MM-DD') : null;

                $('.reportrange').daterangepicker({
                        timePicker: false,
                        autoUpdateInput: false,
                         maxDate: moment(),
                        ranges: {
                            'Today': [moment().startOf('day'), moment().endOf('day')],
                            'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                            'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                            'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                            'This Month': [moment().startOf('month'), moment().endOf('month')],
                            'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                        }
                    }, function (start, end) {
                        cb(start, end);

                        loadData();
                });
                $('#reportrange').on('apply.daterangepicker', function (ev, picker) {

                    cb(picker.startDate, picker.endDate);
                        loadData();
                });
                $('#reportrange span').html('Select Date');
                        cb(start, end);


        });

    </script>
}