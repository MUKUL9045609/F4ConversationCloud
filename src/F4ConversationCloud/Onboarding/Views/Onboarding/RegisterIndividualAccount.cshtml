@using System.Web
@model F4ConversationCloud.Application.Common.Models.OnBoardingRequestResposeModel.RegisterUserModel;
@{
    ViewData["Title"] = "Register Form";
}
@functions {
    string ReadonlyOrEmpty(bool isReadOnly)
    {
        return isReadOnly ? "readonly" : "";
    }

    string DisabledOrEmpty(bool isReadOnly)
    {
        return isReadOnly ? "disabled" : "";
    }
}

<div class="stepswrapper">
    <a href="@Url.Action("Index", "Onboarding")" class="back-btn"> Back</a>
    <div class="d-flex justify-content-end flex-column">
        <span class="step-count">STEP <span>01/02</span></span>
        <span class="step-info">Residency Info.</span>
    </div>

    <a href="@Url.Action("BankVerification", "Onboarding")" class="next-btn" id="nextbtn"> Next</a>
</div>
<div class="bx_wrap">
    <h4>Create Your Business Account!</h4>
    <p>For the purpose of industry regulation, your details are required.</p>

    <form id="firststepform"
          class="login-form mt-4 @(ViewBag.IsReadOnly ? "readonly-mode" : "")"
          asp-action="RegisterIndividualAccount" method="post">

        @Html.AntiForgeryToken()
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label asp-for="FirstName" class="form-label">Your Full Name <sup>*</sup></label>
                <input asp-for="FirstName" type="text"
                       class="form-control flex-grow-1"
                       placeholder="Enter Full Name"
                       id="fullName"
                       pattern="^[a-zA-Z\s'-]+$" />

                <span asp-validation-for="FirstName" class="error-message text-danger small" id="fullNameError"></span>
            </div>


            <div class="col-md-6">
                <label asp-for="Email" class="form-label">Email address <sup>*</sup></label>
                <input asp-for="Email" type="email" class="form-control flex-grow-1" placeholder="Enter Email Address" id="emailid">
                <span asp-validation-for="Email" class="error-message text-danger small" id="emailError"></span>
                <span asp-validation-for="EmailOtpVerified" class="error-message text-danger small" id="emailvarifyerror"></span>
                <div class="verifyBtnLink" id="sendmail">
                    <span>Verify Email</span>
                </div>

            </div>

            <div class="col-md-6 mb-3" id="codeSection" style="display: none;">
                <label for="emailCode" class="form-label">Enter 6 Digit Verification Code</label>
                <div class="d-flex gap-2">
                    <input type="number" asp-for="OTP" class="form-control flex-grow-1" placeholder="Enter OTP" id="otp">
                    <button id="varifyOtp" type="button" class="btn verifyBtn">Verify</button>
                </div>
                <div class="otp-timer">
                    <span class="otp-text d-none">
                        Time remaining: <span class="fw-bold" id="timeRemaining">5:00</span>
                    </span>
                    <a id="resendotp" class="verifyBtnLink">Resend OTP</a>
                </div>
                <span asp-validation-for="OTP" class="error-message text-danger small" id="OtpError"></span>
            </div>



            <div class="col-md-6">
                <label class="form-label">Phone number <sup>*</sup></label>

                <div class="d-flex">
                    <input asp-for="PhoneNumber" type="tel" class="form-control flex-grow-1"
                           placeholder="Enter phone number"
                           id="PhoneNumber" maxlength="10" pattern="[0-9]*" oninput="this.value = this.value.replace(/\s/g,'');" value="@Model.PhoneNumber" />
                </div>
                <span asp-validation-for="PhoneNumber" class="error-message text-danger small" id="phoneError"></span>
                @* <span asp-validation-for="PhoneOtpVerified" class="error-message text-danger small" id="PhoneOtpVerifiederror"></span> *@

                <input type="hidden" asp-for="FullPhoneNumber" id="FullPhoneNumberid" />
                <span asp-validation-for="FullPhoneNumber" class="error-message text-danger small" id="phoneError"></span>
                @* <div class="verifyBtnLink" id="varifyPhoneNumber"><span>Verify Phone No</span></div> *@
            </div>

            <div class="col-md-6 mb-3" id="codeSection" style="display: none;">
                <label for="otpCode" class="form-label">Enter 6 Digit Verification Code</label>
                <div class="d-flex gap-2">
                    <input type="number" class="form-control flex-grow-1" placeholder="Enter OTP" id="otp">
                    <button type="button" id="varifyOtp" class="btn verifyBtn">Verify</button>
                </div>
                <div class="otp-timer">
                    <span class="otp-text d-none">
                        Time remaining: <span class="fw-bold" id="timeRemaining">5:00</span>
                    </span>
                    <a id="resetBtn" class="verifyBtnLink">Resend OTP</a>
                </div>
                <span asp-validation-for="OTP" class="error-message text-danger small" id="OtpError"></span>
            </div>


            <div class="col-md-6 mb-3">
                <label asp-for="Country" class="form-label">Country of residence <sup>*</sup></label>
                <select id="countrySelect" name="Country" class="form-select select2"></select>
                <span asp-validation-for="Country" class="error-message text-danger small"></span>

            </div>
            @* <input type="hidden" asp-for="PhoneOtpVerified" id="PhoneOtpVerified" /> *@

            <div class="col-md-6 mb-3">
                <label asp-for="PassWord" class="form-label">Create Password <sup>*</sup></label>
                <div class="input-group">

                    @if (ViewBag.IsReadOnly)
                    {
                        <input type="text" class="form-control" value="**********" readonly />
                    }
                    else
                    {
                        <input asp-for="PassWord" type="password" class="form-control" placeholder="Enter Password" id="password" />
                    }

                <span class="input-group-text toggle-password" data-target="password" id="passicon">
                    <i class="fa fa-eye-slash" aria-hidden="true"></i>
                </span>
                </div>
                <span asp-validation-for="PassWord" class="error-message text-danger small" id="passwordError"></span>
            </div>

            <div class="col-md-6 mb-3">
                <label asp-for="ConfirmPassword" class="form-label">Confirm Password <sup>*</sup></label>
                <div class="input-group">
                    @if (ViewBag.IsReadOnly)
                    {
                        <input type="text" class="form-control" value="**********" readonly />
                    }
                    else
                    {
                        <input asp-for="ConfirmPassword" type="password" class="form-control flex-grow-1" placeholder="Re-enter Password" id="confirmPassword" />
                    }                  
                    <span class="input-group-text toggle-password" data-target="confirmPassword" id="cpassicon">
                        <i class="fa fa-eye-slash" aria-hidden="true"></i>
                    </span>
                </div>
                <span asp-validation-for="ConfirmPassword" class="error-message text-danger small" id="confirmPasswordError"></span>
            </div>
              <div class="mb-3">
                            <label for="emailCode" class="form-label">Select Current Time Zone</label>
                <select class="form-control select2" asp-for="Timezone">
                    <option value="">Select Time Zone</option>
                    <option value="@Model.Timezone">@Model.Timezone</option>
                    @foreach (var item in Model.TimeZones)
                    {
                        var settimean = item.name + item.current_utc_offset;
                        if (Model.Timezone == settimean)
                        {
                            <option value="@settimean" selected>@settimean</option>
                        }
                        else
                        {
                            <option value="@settimean">@settimean</option>
                        }
                    }

                </select>
                <span asp-validation-for="Timezone" class="error-message text-danger small"></span>
               </div>

            <div class="col-md-12 mb-3">
                <label asp-for="Address" class="form-label">Your address <sup>*</sup></label>
                <textarea asp-for="Address" class="form-control flex-grow-1" placeholder="Enter Address Here"></textarea>
                <span asp-validation-for="Address" class="error-message text-danger small"></span>
            </div>

            <div class="form-check d-flex justify-content-end terms-check gap-2">
                <input asp-for="TermsCondition" class="form-check-input" id="agreeTerms" />
                <label class="form-check-label" for="agreeTerms">
                    <a href="https://fortune4.in/terms-and-conditions/" target="_blank">
                        I agree to terms & conditions
                    </a>
                </label>
            </div>
            <div class="form-check d-flex justify-content-end terms-check gap-2">
                <span asp-validation-for="TermsCondition" class="error-message text-danger small text-end"></span>
            </div>

            <input type="hidden" asp-for="EmailOtpVerified" id="OTP">


            <button type="submit" class="btn login-btn">Register Account</button>
            <span class="lock-text"><span class="lock"></span> Your Info is safely secured</span>
        </div>
    </form>

  
</div>

@section Scripts {
    @*  <script src="~/js/onboarding/OnboardingAjaxCall.js"></script> *@
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  
    <script>
        $(document).ready(function () {
            $(".select2").select2();
        });
    </script>
   


    <script>
                        // #region Resend otp-- >

                    $(document).ready(function () {
                                let timerDuration = 5 * 60;
                                let interval;

                                function startTimer() {
                                    clearInterval(interval);

                                    let remaining = timerDuration;

                                            $("#resendotp").addClass("d-none");
                                    $(".otp-text").removeClass("d-none");
                                    $("#timeRemaining").text(formatTime(remaining));

                                    interval = setInterval(function () {
                                        remaining--;

                                        if (remaining >= 0) {
                                            $("#timeRemaining").text(formatTime(remaining));
                                        }

                                        if (remaining < 0) {
                                            clearInterval(interval);
                                            $(".otp-text").addClass("d-none");
                                                    $("#resendotp").removeClass("d-none");
                                        }
                                    }, 1000);
                                }

                                function formatTime(seconds) {
                                    let minutes = Math.floor(seconds / 60);
                                    let secs = seconds % 60;
                                    return `${minutes}:${secs < 10 ? "0" + secs : secs}`;
                                }


                                $("#sendmail").click(function () {
                                    startTimer();
                                });

                          $("#resendotp").click(function () {


                                    let email = $('#emailid').val().trim();
                                        $("#loader").show();

                                $.ajax({
                                        url: "@Url.ActionLink("VarifyMail", "Onboarding")",
                                        type: "POST",
                                        data: JSON.stringify({
                                            UserEmailId: email,
                                            OTP_Source: "EMAIL"
                                        }),
                                        contentType: "application/json; charset=utf-8",
                                        success: function (response) {
                                            if (response.status === true) {
                                                    $('#codeSection').show();
                                                // alert("OTP sent successfully!");
                                                showToast("OTP sent successfully!", "success");
                                            }
                                            else if(response.status === false && response.message === "Email already exists")
                                            {
                                                $('#emailError').text('Email already exists. Please use a different email.');
                                            }
                                            else {
                                                showToast("Failed to send OTP. Please try again.", "danger");
                                            }

                                        },
                                        error: function (xhr) {
                                            showToast("technical Error", "danger");
                                        },
                                            complete: function () {
                                            $("#loader").hide();
                                        }
                                });



                                });
                            });


        //#region send mail --

        $(document).ready(function () {


                $('#sendmail').click(function(){
                    let email = $('#emailid').val().trim();

                    if(email === ''){
                        // $('#sendmail').prop('disabled', true);
                        $('#emailError').text('Please enter your email address.');
                        return;
                    } else {
                        $('#emailError').text('');
                            //    $('#sendmail').prop('disabled', false);
                    }

                    let emailPattern = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;

                    if (!emailPattern.test(email)) {
                        $('#emailError').text('Please enter a valid email address');

                        return;
                    }
                    $("#loader").show();
                    $.ajax({
                        url:"@Url.ActionLink("VarifyMail", "Onboarding")",
                        type: "POST",
                        data: JSON.stringify({
                            UserEmailId: email,
                            //UserPhoneNumber: $('#phone').val(),
                            OTP_Source: "EMAIL"
                        }),
                        contentType: "application/json; charset=utf-8",
                        success: function (response) {
                            if (response.status === true) {
                                    $('#codeSection').show();
                                    showToast("OTP sent successfully!", "success");
                                    $('#sendmail').addClass('disabled-btn');
                                    $('#sendmail span').text('');
                            }
                            else if(response.status === false && response.message === "Email already exists")
                            {
                                $('#emailError').text('Email already exists. Please use a different email.');

                                    showToast("Email already exists. Please use another one.", "warning");
                            }
                            else {
                                        showToast("Failed to send OTP. Please try again.", "danger");
                            }

                        },
                        error: function (xhr) {
                                            showToast("technical Error", "danger");
                        },
                        complete: function () {
                            $("#loader").hide();
                        }
                    });

                });

            });

        // varify mail otp
        $(document).ready(function () {

                $('#varifyOtp').click(function () {
                    let Otp = $('#otp').val();
                            let email = $('#emailid').val().trim();

                    if (Otp === '' || email === '') {
                        $('#OtpError').text('Please enter the OTP and email.');
                        otpVerified = false;
                        return;
                    }
                       $("#loader").show();
                    $.ajax({
                        url:"@Url.ActionLink("VerifyOtp", "Onboarding")",
                        type: "POST",
                        data: JSON.stringify({
                            UserEmailId: email,
                            OTP: Otp,
                            OTP_Source: "EMAIL"
                        }),
                        contentType: "application/json; charset=utf-8",
                        success: function (response) {

                            $('#OTP').val(response.status);

                            if (response.status === true) {

                                showToast("OTP verified successfully!", "success");
                                $('#OtpError').text('');
                                $('#codeSection').hide();
                                $('#sendmail').addClass('disabled-btn');
                                $('#sendmail span').text('');
                                $('#emailvarifyerror').hide();

                               $('#emailid')
                                .prop('readonly', true)
                                .removeClass('is-invalid')
                                .addClass('form-control flex-grow-1 success');
                            } else {
                                $('#OtpError').text('Invalid OTP. Please try again.');

                            }
                        },
                        error: function (xhr) {
                            $('#OtpError').text('Failed to verify OTP. Please try again.');

                        },
                        complete: function () {

                                $("#loader").hide();
                        }
                    });
                });

        });
    </script>

    <script>
         $(document).ready(function () {

           
                
        // make form readonly
         let $form = $("#firststepform");

            if ($form.hasClass("readonly-mode")) {
                 
                    $form.find("input, select, textarea, button").each(function () {
                        let $element = $(this);

                        if ($element.is("input") || $element.is("textarea")) {
                            $element.prop("readonly", true);
                        }
                        if ($element.is("button") || $element.is("select")) {
                            $element.prop("disabled", true);
                        }
                    });
                        $('#nextbtn').prop("disabled",false);
                        $('#sendmail, #passicon, #cpassicon,#agreeTerms')
                            .addClass('disabled')
                            .css({
                                'pointer-events': 'none',
                                'opacity': '0.5'
                  });
            } else {         
                $('#nextbtn').prop("disabled",true);
            }

        });
    </script>

    <script>
        fetch("/data/countries.json")
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById("countrySelect");

                data.sort((a, b) => a.name.localeCompare(b.name));

                data.forEach(country => {
                const option = document.createElement("option");
                option.value = country.name;
                option.textContent = country.name;
                select.appendChild(option);
                });

                select.value = "India";
            })
            .catch(err => console.error("Error fetching countries:", err));

    </script>

    <script>

     document.addEventListener("DOMContentLoaded", function () {
            var input = document.querySelector("#PhoneNumber");

            if (input) {
                var iti = window.intlTelInput(input, {
                    initialCountry: "in",
                    separateDialCode: true,
                    utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js"
                });


                input.addEventListener("input", function () {
                    var fullNumber = iti.getNumber();
                    document.querySelector("#FullPhoneNumberid").value = fullNumber;
                });


                document.querySelector("form").addEventListener("submit", function () {
                    var fullNumber = iti.getNumber();
                    document.querySelector("#FullPhoneNumberid").value = fullNumber;
                });
            }
        });


    </script>
   #<!-- #region Hide and show pass -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
                const togglePasswordIcons = document.querySelectorAll('.toggle-password');

                togglePasswordIcons.forEach(iconContainer => {
                    iconContainer.addEventListener('click', function() {
                        const targetId = this.dataset.target;
                        const passwordInput = document.getElementById(targetId);
                        const eyeIcon = this.querySelector('i');


                        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                        passwordInput.setAttribute('type', type);


                        eyeIcon.classList.toggle('fa-eye');
                        eyeIcon.classList.toggle('fa-eye-slash');
                    });
                });
            });
    </script>
    <!-- #endregion -->
}