@model Onboarding.Models.RegisterUserViewModel
@{
    ViewData["Title"] = "Register Form";
}
@* @functions {
    string ReadonlyOrEmpty(bool isReadOnly)
    {
        return isReadOnly ? "readonly" : "";
    }

    string DisabledOrEmpty(bool isReadOnly)
    {
        return isReadOnly ? "disabled" : "";
    }
    
   
} *@

<div class="bx_wrap">
    <h4>Create Your Business Account!</h4>
    <p>For the purpose of industry regulation, your details are required.</p>

    <form id="firststepform"
          class="login-form mt-4 @(ViewBag.DisableButtons ? "readonly-mode" : "")"
          asp-action="RegisterIndividualAccount" method="post">

        @Html.AntiForgeryToken()

        <div class="register-group-form">
                <div class="group-form">
                    <label asp-for="FirstName" class="form-label"> Full Name <sup class="error">*</sup></label>
                    <input asp-for="FirstName" type="text"
                           class="form-control flex-grow-1"
                           placeholder="Enter Full Name"
                           id="fullName"
                           pattern="^[a-zA-Z\s'-]+$" />

                    <span asp-validation-for="FirstName" class="error-message text-danger small" id="fullNameError"></span>
                </div>
                <div class="group-form">
                    <label asp-for="Email" class="form-label">Email address <sup class="error">*</sup></label>
                    <input asp-for="Email" type="email" class="form-control flex-grow-1" placeholder="Enter Email Address" id="emailid">
                    <span asp-validation-for="Email" class="error-message text-danger small" id="emailError"></span>
               

                </div>
                <div class="group-form">
                <label class="form-label">Contact Number<sup class="error">*</sup></label>
                @* <div class="verifyBtnLink" ><span>Verify</span></div> *@
                <div class="verifyBtnLink" id="varifyPhoneNumberbtn">
                    <span class="verify-btn">Verify</span>
                    <span class="verified d-none">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M8.85297 4.82147L5.35305 8.29796C5.30671 8.34403 5.25169 8.38057 5.19112 8.40551C5.13055 8.43045 5.06563 8.44328 5.00006 8.44328C4.9345 8.44328 4.86957 8.43045 4.80901 8.40551C4.74844 8.38057 4.69342 8.34403 4.64708 8.29796L3.14711 6.80804C3.09929 6.76229 3.06112 6.70751 3.03484 6.64696C3.00855 6.5864 2.99468 6.52126 2.99401 6.45532C2.99334 6.38938 3.00589 6.32396 3.03095 6.2629C3.056 6.20183 3.09305 6.14633 3.13992 6.09963C3.1868 6.05294 3.24257 6.01599 3.30397 5.99093C3.36538 5.96587 3.4312 5.95323 3.49759 5.95371C3.56397 5.95418 3.6296 5.96778 3.69064 5.99372C3.75167 6.01966 3.8069 6.05742 3.85309 6.10478L5.00006 7.24411L8.147 4.11822C8.19319 4.07085 8.24841 4.03309 8.30945 4.00715C8.37048 3.98121 8.43611 3.96762 8.50249 3.96714C8.56888 3.96666 8.6347 3.97931 8.69611 4.00436C8.75752 4.02942 8.81328 4.06637 8.86016 4.11307C8.90704 4.15976 8.94408 4.21526 8.96914 4.27633C8.99419 4.3374 9.00675 4.40281 9.00608 4.46875C9.00541 4.53469 8.99153 4.59984 8.96525 4.66039C8.93896 4.72094 8.90079 4.77572 8.85297 4.82147ZM11.9309 7.10104L11.3419 5.95977L11.9299 4.81747C12.0014 4.67888 12.0187 4.51889 11.9782 4.36842C11.9377 4.21794 11.8425 4.08774 11.7109 4.00303L10.6259 3.30772L10.5609 2.02938C10.555 1.8729 10.49 1.72437 10.3788 1.61337C10.2677 1.50237 10.1184 1.43703 9.96095 1.4304L8.67098 1.36487L7.968 0.285131C7.88196 0.15529 7.75075 0.0615418 7.59946 0.0217752C7.44818 -0.0179914 7.28745 -0.000964519 7.14802 0.0696085L6.00004 0.653672L4.85007 0.0696085C4.71052 -0.00181671 4.54917 -0.0189963 4.39755 0.0214115C4.24592 0.0618192 4.1149 0.156883 4.03009 0.288102L3.3291 1.36584L2.04013 1.4304C1.88306 1.43676 1.73414 1.50156 1.62297 1.61197C1.51181 1.72239 1.44655 1.87032 1.44015 2.02635L1.37415 3.30772L0.286174 4.00497C0.155281 4.09029 0.060793 4.22071 0.0209139 4.37109C-0.0189652 4.52147 -0.00141804 4.68117 0.0701758 4.81947L0.65816 5.96074L0.0701758 7.10304C-0.00130445 7.24148 -0.0184814 7.40136 0.021982 7.55167C0.0624454 7.70197 0.157667 7.83198 0.289173 7.91651L1.37415 8.61285L1.43915 9.89016C1.45315 10.2179 1.71314 10.4762 2.03913 10.4901L3.3291 10.5547L4.03208 11.6354C4.20908 11.9036 4.56207 11.9949 4.85207 11.8499L6.00004 11.2659L7.15002 11.851C7.28948 11.9228 7.45097 11.9403 7.60272 11.8998C7.75447 11.8594 7.88549 11.764 7.97 11.6324L8.67098 10.5547L9.95695 10.4911C10.1148 10.4855 10.2647 10.4209 10.3767 10.3102C10.4887 10.1996 10.5545 10.0509 10.5609 9.89416L10.6259 8.61285L11.7139 7.91457C11.8447 7.82943 11.9392 7.69921 11.9791 7.549C12.019 7.39879 12.0024 7.23919 11.9309 7.10104Z" fill="#009168" />
                        </svg>
                        Verified
                    </span>
                </div>
                <div class="d-flex phonewrap">
                    <input asp-for="PhoneNumber" type="text" class="form-control flex-grow-1"
                           placeholder="Enter Contact Number"
                           id="PhoneNumber" maxlength="10" />
                </div>
                <span asp-validation-for="PhoneNumber" class="error-message text-danger small" id="phoneError"></span>
                <span asp-validation-for="PhoneNumberOtpVerified" class="error-message text-danger small" id="PhoneOtpVerifiederror"></span>
                <input type="hidden" asp-for="CountryCode" id="CountryCodeid" />
                <input type="hidden" asp-for="PhoneNumberOtpVerified" id="PhoneNumberOtpVerifiedId">
                <span asp-validation-for="CountryCode" class="error-message text-danger small" id="phoneError"></span>
                
            </div>

                <div class="group-form" >
                <div class="otp-section" id="contactNoOtpDiv" style="display: none;">

                    <label for="otpCode" class="form-label">Enter 6 Digit Verification Code</label>
                    <div class="d-flex gap-2">
                            <div class="otp-form d-flex" id="otp-form">
                                <input type="text" class="otp-input" maxlength="1">
                                <input  type="text" class="otp-input" maxlength="1">
                                <input type="text" class="otp-input" maxlength="1">
                                <input  type="text" class="otp-input" maxlength="1">
                                <input type="text" class="otp-input" maxlength="1">
                                <input  type="text" class="otp-input" maxlength="1">
                                @* <input asp-for="OTP" type="number" class="form-control flex-grow-1" placeholder="Enter OTP" > *@
                            <input type="hidden" asp-for="OTP" id="contactNoOtpinput" />
                            </div>
                            <button type="button" id="varifycontactNoOtpbtn" class="btn verifyBtn">Verify</button>
                    </div>
                    <div class="otp-timer d-flex justify-content-between">
                        <span class="otp-text d-none">
                            Valid till  <span class="fw-bold" id="timeRemaining">5:00</span>
                        </span>
                        <a id="resendOtpBtn" class="verifyBtnLink" style="display: none;">Resend OTP</a>
                    </div>
                    <span asp-validation-for="OTP" class="error-message text-danger small" id="contactNoOtpError"></span>
                </div>
               
            </div>

                 <div class="group-form">
                <label asp-for="PassWord" class="form-label">Create Password <sup class="error">*</sup></label>


                @if (ViewBag.DisableButtons)
                {
                    <input type="text" class="form-control" value="**********" readonly />
                }
                else
                {

                    <div class="d-flex password-wrap">
                        <input asp-for="PassWord" type="password" class="form-control" placeholder="Enter Password" id="password" />
                        <i class="toggle-password fa fa-fw fa-eye-slash"></i>
                    </div>
                }
                <span asp-validation-for="PassWord" class="error-message text-danger small" id="passwordError"></span>
            </div>

                <div class="group-form">
                    <label asp-for="ConfirmPassword" class="form-label">Confirm Password <sup class="error">*</sup></label>
                    @if (ViewBag.DisableButtons)
                    {
                        <input type="text" class="form-control" value="**********" readonly />
                    } 
                    else
                    {
                        <div class="d-flex password-wrap">
                            <input asp-for="ConfirmPassword" type="password" class="form-control flex-grow-1" placeholder="Re-enter Password" id="confirmPassword" />
                            <i class="toggle-password fa fa-fw fa-eye-slash"></i>
                        </div>
                    }
                    <span asp-validation-for="ConfirmPassword" class="error-message text-danger small" id="confirmPasswordError"></span>
                </div>
                <div class="group-form">
                    <label for="OrganizationsName" class="form-label">Organizations Name <sup class="error">*</sup></label>
                    <input asp-for="OrganizationsName" type="text" class="form-control" placeholder="Enter your organizations name"
                           id="email">
                    <span asp-validation-for="OrganizationsName" class="error-message text-danger small"></span>
                </div>
           
                <div class="group-form">
                    <label for="emailCode" class="form-label">Select Current Time Zone <sup class="error">*</sup></label>
                    <select class="form-control select2" asp-for="Timezone">
                        <option value="" selected disabled>Select Time Zone</option>
                        <option value="@Model.Timezone">@Model.Timezone</option>

                        @foreach (var item in Model.TimeZones)
                        {
                            var settimean = item.name + item.current_utc_offset;
                            if (Model.Timezone == settimean)
                            {
                                <option value="@settimean" selected>@settimean</option>
                            }
                            else
                            {
                                <option value="@settimean">@settimean</option>
                            }
                        }

                    </select>
                    <span asp-validation-for="Timezone" class="error-message text-danger small"></span>
                </div>
           
                <h5>Address</h5>
                <div class="group-form w-100">
                    
                         <label  class="form-label">Address Line 1 <sup class="error">*</sup></label>
                        <textarea asp-for="Address" class="form-control flex-grow-1" placeholder="Enter Address Here" id="addreessline1"></textarea>
                        <span asp-validation-for="Address" class="error-message text-danger small"></span>
                   
                </div>
                <div class="group-form w-100">
                    
                        <label class="form-label">Address Line 2 (Optional)</label>
                    <input asp-for="OptionalAddress" type="text" class="form-control"
                               placeholder="Apartment, suite, unit, building, floor, etc." id="addresstwo"
                               >       
                </div>

                <div class="group-form">
                    <label asp-for="Country" class="form-label">Country of residence <sup class="error">*</sup></label>
                        <input type="hidden" name="Country" id="hiddenCountry" value="India" />
                        <select id="countrySelect" class="form-select select2" disabled>
                            <option value="India" selected>India</option>
                        </select>
                        <span asp-validation-for="Country" class="error-message text-danger small"></span>
                </div>

                <div class="group-form">
                    
                        <label for="state" class="form-label">State <sup class="error">*</sup></label>
                        
                        <select id="StateSelect" class="form-control select2" asp-for="StateId" >
                        @if (ViewBag.DisableButtons)
                            {
                                <!-- Show only the selected state -->
                                <option value="@Model.StateId" selected>@Model.StateId</option>
                            }
                            else
                            {
                                <option value="" selected disabled>Select State</option>
                                @foreach (var item in Model.States)
                                {
                                    <option value="@item.Id">@item.Name</option>
                                }
                            }
                        </select>

                        @if (!ViewBag.DisableButtons)
                        {
                            <span asp-validation-for="StateId" class="error-message text-danger small"></span>
                        }
                </div>

                <div class="group-form">
                    <div>
                        <label for="CitySelect" class="form-label">City <sup class="error">*</sup></label>
                       
                            <select id="CitySelect" class="form-control select2" asp-for="CityId">
                             @if (ViewBag.DisableButtons)
                                {
                                    <option value="@Model.CityId" selected>@Model.CityId</option>
                                }
                                else
                                {
                                    <option value="" selected disabled>Select City</option>
                                    
                                }
                            </select>

                            @if (!ViewBag.DisableButtons)
                            {
                                <span asp-validation-for="CityId" class="error-message text-danger small"></span>
                            }

                    </div>
                </div>


                <div class="group-form">
                    
                        <label asp-for="ZipCode" class="form-label">
                            Postal / ZIP Code <sup class="error">*</sup>
                        </label>
                        <input asp-for ="ZipCode" type="text" class="form-control" id="postal_code" 
                               placeholder="Enter your postal or ZIP code" >
                    <span asp-validation-for="ZipCode" class="error-message text-danger small"></span>
                    
                </div>
           
        
        </div>
        <div class="form-check d-flex justify-content-start terms-check gap-2 mt-1">
            <input asp-for="TermsCondition" class="form-check-input" id="agreeTerms" />
            <label class="form-check-label" for="agreeTerms" data-bs-toggle="modal" data-bs-target="#createTemplate">
                By continuing, I agree to the <a href="javascript:void(0)" data-bs-toggle="modal"
                                                    data-bs-target="#createTemplate" >Terms & Conditions</a>
                <span asp-validation-for="TermsCondition" class="error-message text-danger small d-block"></span>

              </label>

        </div>
           

        <button type="submit" class="btn login-btn">Register Account</button>
            <span class="lock-text"><span class="lock"></span> Your Info is safely secured</span>
    </form>


</div>
@section Scripts {
 
    @{
     await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            $(".select2").select2();

        $('#TermsConditionsverifyBtn').click(function () {
            $('#agreeTerms').prop('checked', true);   
            $('#agreeTerms').val(true);               
            $('#createTemplate').modal('hide');      
        });

     
        $('#agreeTerms').change(function () {
            if ($(this).is(':checked')) {
                $(this).val(true);
            } else {
                $(this).val(false);
            }
        });
        });
        
    </script>

    <script>
        // #region Resend otp-- >

         $(document).ready(function () {

                 const fieldIds = [
                    'addreessline1',
                    'addresstwo',
                    'StateSelect',
                    'CitySelect',
                    'postal_code',
                    'agreeTerms',
                    'TermsConditionsverifyBtn'
                    ];

                 fieldIds.forEach(id => {
                    $('#' + id).prop('disabled', true);
                });
             let timerDuration = 2 * 60;
             let interval;

             function startTimer() {
                 clearInterval(interval);

                 let remaining = timerDuration;

                  $("#resendOtpBtn").hide();
                 $(".otp-text").removeClass("d-none");
                 $("#timeRemaining").text(formatTime(remaining));

                 interval = setInterval(function () {
                     remaining--;

                     if (remaining >= 0) {
                         $("#timeRemaining").text(formatTime(remaining));
                     }

                     if (remaining === 0) {
                         clearInterval(interval);
                         $(".otp-text").addClass("d-none");
                         $("#resendOtpBtn").show();
                     }
                 }, 1000);
             }

             function formatTime(seconds) {
                 let minutes = Math.floor(seconds / 60);
                 let secs = seconds % 60;
                 return `${minutes}:${secs < 10 ? "0" + secs : secs}`;
             }
             function sendOTP() {
                 if (!$("#PhoneNumber").valid()) return;

                 $("#loader").show();

                 var PhoneNumber = $('#PhoneNumber').val();
                 var CountryCode = $('#CountryCodeid').val();

                 var req = {
                     UserPhoneNumber: PhoneNumber,
                     CountryCode: CountryCode
                 };

                 var url = "@Url.ActionLink("VarifyWhatsAppNumber", "Onboarding")";

                 ajaxHelper.ajaxPost(
                     url,
                     null,
                     req,
                     function (response) {
                            $("#loader").hide();
                         if (response.status === true) {
                             commonHelper.showSuccess(response.message)
                            // showToast(response.message, "success");
                             $('#contactNoOtpDiv').show();
                                $('#varifyPhoneNumberbtn').hide();
                             startTimer();
                         } else {
                             $('#phoneError').text(response.message);

                         }
                     },
                     function (xhr) {
                         commonHelper.showError("Technical Error.!")
                         // showToast("Technical Error. Please try again.", "danger");
                     },
                     function () {
                         $("#loader").hide();
                     }
                 );
             }

              $('#varifyPhoneNumberbtn').click(function (e) {
                 e.preventDefault();
                 sendOTP();
             });
              $('#resendOtpBtn').click(function (e) {
                 e.preventDefault();
                $('.otp-input').val('');
                $('#contactNoOtpinput').val('');
                $('#contactNoOtpError').val('');
                $('#contactNoOtpError').text('');

                $('.otp-input').first().focus();
                 sendOTP();
             });
             // varify otp
              $('#varifycontactNoOtpbtn').click(function (e) {
                 e.preventDefault();

                 if (!$("#PhoneNumber").valid() ) {
                   return;
                 }
                 if (!$("#contactNoOtpinput").valid()) {
                   return;
                 }

                 $("#loader").show();

                 var PhoneNumber = $('#PhoneNumber').val();
                 var CountryCode = $('#CountryCodeid').val();
                 var contactNoOTP = $('#contactNoOtpinput').val();

                 var req = {
                     UserPhoneNumber: PhoneNumber,
                     CountryCode: CountryCode,
                     OTP: contactNoOTP
                 };

                 var url = "@Url.ActionLink("VerifyOtp", "Onboarding")";

                 ajaxHelper.ajaxPost(
                     url,
                     null,
                     req,
                     function (response) {
                         $("#loader").hide();
                         
                         if (response.status === true) {
                            $('#PhoneNumberOtpVerifiedId').val(response.status);
                            //showToast(response.message, "success");
                            commonHelper.showSuccess(response.message)
                            $('#contactNoOtpDiv,#phoneError').hide();
                            $('#varifyPhoneNumberbtn').addClass('disabled-btn');
                            $('#varifyPhoneNumberbtn span').text('');
                            $('#PhoneNumber')
                                 .prop('readonly', true)
                                 .removeClass('is-invalid')
                                 .addClass('form-control flex-grow-1 success');
                                 fieldIds.forEach(id => {
                                    $('#' + id).prop('disabled', false);
                                });
                         }
                         else
                         {
                               //$("#resendOtpBtn").removeClass("d-none"); verifyBtnLink
                              // $("#resendOtpBtn").addClass("d-none");
                                //clearInterval(interval);
                               // $(".otp-text").addClass("d-none");
                               // $("#resendOtpBtn").removeClass("d-none").addClass("resend-otp");

                               $('#contactNoOtpError').text(response.message || 'Invalid OTP. Please try again.');
                         }
                     },
                     function (xhr) {
                         $("#loader").hide();
                         $('#OtpError').text('Failed to verify OTP. Please try again.');
                     }
                 );
             });
        });

    </script>

    <script>
        // make form readonly
         $(document).ready(function () {
         let $form = $("#firststepform");
            var isReadOnly = @Json.Serialize(ViewBag.IsReadOnly);
                var disableButtons = @Json.Serialize(ViewBag.DisableButtons);

                if (isReadOnly) {
                    $('#fullName, #emailid, #PhoneNumber').prop("disabled", true);
                }

            if ($form.hasClass("readonly-mode")) {

                $form.find("input, select, textarea, button").each(function () {
                    let $element = $(this);

                    if ($element.is("input") || $element.is("textarea")) {
                        $element.prop("readonly", true);
                    }
                    if ($element.is("button") || $element.is("select")) {
                        $element.prop("disabled", true);
                    }
                });
               
                $(' #passicon, #cpassicon,#agreeTerms')
                    .addClass('disabled')
                    .css({
                        'pointer-events': 'none',
                        'opacity': '0.5'
                        });
                $('#varifyPhoneNumberbtn').hide();
            }

        });
    </script>

    <script>
            fetch("/data/countries.json")
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById("countrySelect");
            const hiddenInput = document.getElementById("hiddenCountry");

            
            data.sort((a, b) => a.name.localeCompare(b.name));

            select.innerHTML = "";
            const option = document.createElement("option");
            option.value = "India";
            option.textContent = "India";
            select.appendChild(option);

            select.value = "India";
            select.disabled = true;
            hiddenInput.value = "India";
        })
        .catch(err => console.error("Error fetching countries:", err));


   $(document).ready(function () {
        $('#StateSelect').on('change', function () {
                var SelectedState = $(this).val();

                if (!SelectedState) return;

                
                $('#StateSelect').removeClass('input-validation-error');
                $('span[data-valmsg-for="StateId"]').text('');

                var url = "@Url.Action("GetCitiesByStateId", "Onboarding")";

                $.ajax({
                    url: url,
                    type: "POST",
                    data: { stateId: SelectedState },
                    success: function (response) {
                        var cityDropdown = $('#CitySelect');
                        cityDropdown.empty();
                        cityDropdown.append('<option value="" selected disabled>Select City</option>');

                        if (response && response.length > 0) {
                            $.each(response, function (index, city) {
                                cityDropdown.append('<option value="' + city.id + '">' + city.name + '</option>');
                            });
                        } else {
                            cityDropdown.append('<option disabled>No cities found</option>');
                        }

                       
                    },
                    error: function () {
                        //showToast("Technical Error!", "danger");
                        commonHelper.showError("Technical Error.!")

                    }
                });
            });

            
            $('#CitySelect').on('change', function () {
                $('#CitySelect').removeClass('input-validation-error');
                $('span[data-valmsg-for="CityId"]').text('');
            });
            $('#Timezone').on('change', function () {
                $('#Timezone').removeClass('input-validation-error');
                $('span[data-valmsg-for="Timezone"]').text('');
            });

            $('#varifyPhoneNumberbtn').click(function () {
                $('.otp-section').show(300);
            });
       
        });

    </script>


    <script>

     $(document).ready(function () {
            var $inputs = $(".otp-input");
            var $hiddenOtp = $("#contactNoOtpinput");

            $inputs.on("input", function () {
                var $this = $(this);
                var val = $this.val();

                
                if (!/^\d$/.test(val)) {
                    $this.val('');
                    return;
                }

                
                var nextIndex = $inputs.index(this) + 1;
                if (val && nextIndex < $inputs.length) {
                    $inputs.eq(nextIndex).focus();
                }

                updateHiddenOtp();
            });

            $inputs.on("keydown", function (e) {
                var $this = $(this);

                
                if (e.key === "Backspace" && !$this.val()) {
                    var prevIndex = $inputs.index(this) - 1;
                    if (prevIndex >= 0) $inputs.eq(prevIndex).focus();
                }

                
                setTimeout(updateHiddenOtp, 0);
            });

            function updateHiddenOtp() {
                var otpVal = "";
                $inputs.each(function () {
                    otpVal += $(this).val();
                });

                $hiddenOtp.val(otpVal);

                if ($hiddenOtp.length && typeof $hiddenOtp.valid === "function") {
                    $hiddenOtp.valid();
                }
            }
        });




        document.addEventListener("DOMContentLoaded", function () {
            var input = document.getElementById("PhoneNumber");
            var hiddenInput = document.getElementById("CountryCodeid");

            if (input && hiddenInput) {
                var iti = window.intlTelInput(input, {
                    initialCountry: "in",
                    separateDialCode: true,
                    nationalMode: true,
                    formatOnDisplay: false,
                    utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js"
                });


                var updateHiddenField = function () {
                    var countryData = iti.getSelectedCountryData();
                    hiddenInput.value = "+" + countryData.dialCode;
                };


                input.addEventListener('countrychange', updateHiddenField);
                var currentValue = input.value.trim();
                    if (currentValue.startsWith('+')) {
                        iti.setNumber(currentValue);
                    }
                   updateHiddenField();

            }
        });

    </script>
}